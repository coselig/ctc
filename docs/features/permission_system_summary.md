# å·¥åœ°ç´€éŒ„ç…§ç‰‡ç³»çµ±æ¬Šé™ç®¡ç† - å®Œæˆç¸½çµ

## ğŸ‰ å¯¦ç¾å®Œæˆ

æ‚¨çš„å·¥åœ°ç´€éŒ„ç…§ç‰‡ç³»çµ±æ¬Šé™ç®¡ç†åŠŸèƒ½å·²æˆåŠŸå¯¦ç¾ï¼ä»¥ä¸‹æ˜¯å®Œæ•´çš„åŠŸèƒ½ç¸½çµï¼š

## âœ… å·²å¯¦ç¾åŠŸèƒ½

### 1. ä¸‰ç´šæ¬Šé™åˆ¶åº¦

- **ç¬¬ä¸€ç´š (ğŸ‘¤)**: ä¸€èˆ¬ç”¨æˆ¶ - å¯ä¸Šå‚³åœ–ç‰‡ã€åˆªé™¤è‡ªå·±çš„åº§æ¨™é»
- **ç¬¬äºŒç´š (â­)**: é€²éšç”¨æˆ¶ - é¡å¤–å¯åˆªé™¤å…¶ä»–äººçš„åº§æ¨™é»  
- **ç¬¬ä¸‰ç´š (ğŸ‘‘)**: ç®¡ç†å“¡ - é¡å¤–å¯åˆªé™¤è¨­è¨ˆåœ–

### 2. æ“æœ‰è€…ç®¡ç†åŠŸèƒ½

- âœ… ç®¡ç†èª°èƒ½çœ‹åˆ°è¨­è¨ˆåœ–ï¼ˆç”±æ“æœ‰è€…ç®¡ç†ï¼‰
- âœ… è½‰ç§»ç®¡ç†æ¬Šçµ¦å…¶ä»–ç”¨æˆ¶
- âœ… æ·»åŠ /ç§»é™¤ç”¨æˆ¶æ¬Šé™
- âœ… ä¿®æ”¹ç”¨æˆ¶æ¬Šé™ç­‰ç´š

### 3. æ¬Šé™æ§åˆ¶é‚è¼¯

- âœ… ä¸Šå‚³åœ–ç‰‡æ¬Šé™æª¢æŸ¥
- âœ… åˆªé™¤è‡ªå·±åº§æ¨™é»æ¬Šé™
- âœ… åˆªé™¤ä»–äººåº§æ¨™é»æ¬Šé™
- âœ… åˆªé™¤è¨­è¨ˆåœ–æ¬Šé™

### 4. ç”¨æˆ¶ç•Œé¢

- âœ… æ¬Šé™ç®¡ç†é é¢
- âœ… æ·»åŠ ç”¨æˆ¶æ¬Šé™å°è©±æ¡†
- âœ… è¨­è¨ˆåœ–é¸æ“‡å™¨æ¬Šé™å…¥å£
- âœ… æ¬Šé™ç­‰ç´šè¦–è¦ºåŒ–æ¨™è­˜

## ğŸ“ æ–°å¢æª”æ¡ˆ

### æ¨¡å‹é¡åˆ¥

- `lib/models/permission_level.dart` - æ¬Šé™ç­‰ç´šæšèˆ‰
- `lib/models/floor_plan_permission.dart` - è¨­è¨ˆåœ–æ¬Šé™æ¨¡å‹
- `lib/models/models.dart` - æ¨¡å‹çµ±ä¸€å°å‡º

### æœå‹™é¡åˆ¥

- `lib/services/permission_service.dart` - æ¬Šé™ç®¡ç†æœå‹™

### UI çµ„ä»¶

- `lib/pages/permission_management_page.dart` - æ¬Šé™ç®¡ç†é é¢

### æ–‡æª”

- `docs/permission_system_database.md` - è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ
- `docs/permission_system_user_guide.md` - ä½¿ç”¨è€…æŒ‡å—

## ğŸ”§ ä¿®æ”¹çš„æª”æ¡ˆ

### æ ¸å¿ƒæœå‹™

- `lib/services/supabase_service.dart`
  - æ•´åˆæ¬Šé™æœå‹™
  - ä¸Šå‚³è¨­è¨ˆåœ–æ™‚è‡ªå‹•å‰µå»ºæ“æœ‰è€…æ¬Šé™
  - åˆªé™¤æ“ä½œå‰æª¢æŸ¥æ¬Šé™
  - æ–°å¢åˆªé™¤ç…§ç‰‡è¨˜éŒ„æ¬Šé™æª¢æŸ¥æ–¹æ³•

### UI æ›´æ–°

- `lib/pages/floor_plan_selector_page.dart`
  - æ·»åŠ æ¬Šé™ç®¡ç†å…¥å£
  - æ›´æ–°è¨­è¨ˆåœ–å¡ç‰‡UI
  - æ–°å¢æ¬Šé™ç®¡ç†å°èˆª

## ğŸ’¾ éœ€è¦çš„è³‡æ–™åº«è¨­å®š

è«‹åœ¨ Supabase ä¸­åŸ·è¡Œä»¥ä¸‹ SQL ä¾†å‰µå»ºæ¬Šé™ç®¡ç†è¡¨ï¼š

```sql
-- å‰µå»ºæ¬Šé™ç®¡ç†è¡¨
CREATE TABLE floor_plan_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    floor_plan_id TEXT NOT NULL,
    floor_plan_url TEXT NOT NULL,
    floor_plan_name TEXT NOT NULL,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    user_email TEXT NOT NULL,
    permission_level INTEGER NOT NULL DEFAULT 1 CHECK (permission_level BETWEEN 1 AND 3),
    is_owner BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(floor_plan_url, user_id)
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_floor_plan_permissions_floor_plan_url ON floor_plan_permissions(floor_plan_url);
CREATE INDEX idx_floor_plan_permissions_user_id ON floor_plan_permissions(user_id);
CREATE INDEX idx_floor_plan_permissions_is_owner ON floor_plan_permissions(is_owner);

-- å‰µå»ºè½‰ç§»æ“æœ‰è€…æ¬Šé™çš„å‡½æ•¸
CREATE OR REPLACE FUNCTION transfer_floor_plan_ownership(
    p_floor_plan_url TEXT,
    p_old_owner_id UUID,
    p_new_owner_id UUID
)
RETURNS VOID AS $$
BEGIN
    UPDATE floor_plan_permissions 
    SET is_owner = FALSE, permission_level = 3, updated_at = NOW()
    WHERE floor_plan_url = p_floor_plan_url AND user_id = p_old_owner_id AND is_owner = TRUE;
    
    UPDATE floor_plan_permissions 
    SET is_owner = TRUE, permission_level = 3, updated_at = NOW()
    WHERE floor_plan_url = p_floor_plan_url AND user_id = p_new_owner_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'è½‰ç§»æ¬Šé™å¤±æ•—ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç”¨æˆ¶æ¬Šé™è¨˜éŒ„';
    END IF;
END;
$$ LANGUAGE plpgsql;

-- å•Ÿç”¨è¡Œç´šå®‰å…¨æ€§
ALTER TABLE floor_plan_permissions ENABLE ROW LEVEL SECURITY;

-- è¨­å®šå®‰å…¨ç­–ç•¥
CREATE POLICY "Users can view their own permissions" ON floor_plan_permissions
    FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "Owners can manage permissions" ON floor_plan_permissions
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM floor_plan_permissions fp
            WHERE fp.floor_plan_url = floor_plan_permissions.floor_plan_url
              AND fp.user_id = auth.uid()
              AND fp.is_owner = TRUE
        )
    );

CREATE POLICY "System can create owner permissions" ON floor_plan_permissions
    FOR INSERT WITH CHECK (is_owner = TRUE AND user_id = auth.uid());
```

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### 1. è¨­å®šè³‡æ–™åº«

åŸ·è¡Œä¸Šè¿° SQL èªå¥å‰µå»ºå¿…è¦çš„è¡¨å’Œå‡½æ•¸

### 2. æ¸¬è©¦æ¬Šé™åŠŸèƒ½

1. ä¸Šå‚³ä¸€å€‹æ–°çš„è¨­è¨ˆåœ–ï¼ˆè‡ªå‹•æˆç‚ºæ“æœ‰è€…ï¼‰
2. åœ¨è¨­è¨ˆåœ–é¸æ“‡å™¨ä¸­é»æ“Šå³ä¸Šè§’çš„é¸é …æŒ‰éˆ•
3. é¸æ“‡ã€Œæ¬Šé™ç®¡ç†ã€
4. å˜—è©¦æ·»åŠ å…¶ä»–ç”¨æˆ¶çš„æ¬Šé™

### 3. æ¬Šé™æ¸¬è©¦å ´æ™¯

- ç”¨ä¸åŒæ¬Šé™ç­‰ç´šçš„ç”¨æˆ¶æ¸¬è©¦ç…§ç‰‡è¨˜éŒ„çš„åˆªé™¤
- æ¸¬è©¦è¨­è¨ˆåœ–çš„åˆªé™¤æ¬Šé™
- æ¸¬è©¦æ¬Šé™è½‰ç§»åŠŸèƒ½

## ğŸ”’ å®‰å…¨æ€§ç‰¹æ€§

- **è¡Œç´šå®‰å…¨æ€§ (RLS)**: ç¢ºä¿ç”¨æˆ¶åªèƒ½è¨ªå•æœ‰æ¬Šé™çš„è³‡æº
- **æ¬Šé™æª¢æŸ¥**: æ¯å€‹æ“ä½œå‰éƒ½æœƒé©—è­‰ç”¨æˆ¶æ¬Šé™
- **å¯©è¨ˆè¨˜éŒ„**: æ‰€æœ‰æ¬Šé™è®Šæ›´éƒ½æœ‰æ™‚é–“æˆ³
- **ç´šè¯åˆªé™¤**: ç”¨æˆ¶åˆªé™¤æ™‚è‡ªå‹•æ¸…ç†ç›¸é—œæ¬Šé™

## ğŸ“Š ç³»çµ±æ¶æ§‹

```
ç”¨æˆ¶ç•Œé¢å±¤
â”œâ”€â”€ PermissionManagementPage (æ¬Šé™ç®¡ç†é é¢)
â”œâ”€â”€ AddUserPermissionDialog (æ·»åŠ ç”¨æˆ¶å°è©±æ¡†)
â””â”€â”€ FloorPlanSelectorPage (è¨­è¨ˆåœ–é¸æ“‡å™¨)

æ¥­å‹™é‚è¼¯å±¤
â”œâ”€â”€ PermissionService (æ¬Šé™ç®¡ç†æœå‹™)
â”œâ”€â”€ SupabaseService (æ•¸æ“šæœå‹™)
â””â”€â”€ Permission models (æ¬Šé™æ¨¡å‹)

æ•¸æ“šå­˜å„²å±¤
â”œâ”€â”€ floor_plan_permissions (æ¬Šé™è¡¨)
â”œâ”€â”€ floor_plans (è¨­è¨ˆåœ–è¡¨)
â””â”€â”€ photo_records (ç…§ç‰‡è¨˜éŒ„è¡¨)
```

## ğŸ¯ æ ¸å¿ƒå„ªå‹¢

1. **å®Œæ•´çš„æ¬Šé™é«”ç³»**: ä¸‰ç´šæ¬Šé™æ»¿è¶³ä¸åŒå ´æ™¯éœ€æ±‚
2. **éˆæ´»çš„ç®¡ç†æ©Ÿåˆ¶**: æ“æœ‰è€…å¯è‡ªç”±ç®¡ç†ç”¨æˆ¶æ¬Šé™
3. **å®‰å…¨çš„æ¬Šé™è½‰ç§»**: æ”¯æ´ç®¡ç†æ¬Šè½‰ç§»çµ¦å…¶ä»–ç”¨æˆ¶
4. **ç›´è§€çš„ç”¨æˆ¶ç•Œé¢**: æ¸…æ™°çš„æ¬Šé™ç­‰ç´šè¦–è¦ºæ¨™è­˜
5. **å¼·å¤§çš„å®‰å…¨ä¿éšœ**: å¤šå±¤æ¬¡çš„æ¬Šé™æª¢æŸ¥å’Œæ•¸æ“šä¿è­·

## ğŸ‰ æ­å–œ

æ‚¨çš„å·¥åœ°ç´€éŒ„ç…§ç‰‡ç³»çµ±ç¾åœ¨å…·å‚™äº†ä¼æ¥­ç´šçš„æ¬Šé™ç®¡ç†åŠŸèƒ½ã€‚ç”¨æˆ¶å¯ä»¥å®‰å…¨åœ°å”ä½œè™•ç†å·¥åœ°è¨˜éŒ„ï¼ŒåŒæ™‚ç¢ºä¿æ•¸æ“šçš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–éœ€è¦é€²ä¸€æ­¥çš„åŠŸèƒ½æ“´å±•ï¼Œè«‹éš¨æ™‚è¯ç¹«é–‹ç™¼åœ˜éšŠï¼
